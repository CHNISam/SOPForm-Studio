<!doctype html>
<html lang="en">
  <!-- 
  SOPForm Studio (SFS) v1.0.0
  Schema Version: 1.0.0
  Storage Key: sfs_v1_store
-->
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SOPForm Studio (SFS) v1.0.0</title>
    <style>
      :root {
        --bg-color: #f4f4f9;
        --header-bg: #2c3e50;
        --header-text: #ecf0f1;
        --col-bg: #ffffff;
        --border-color: #ddd;
        --primary-color: #3498db;
        --text-color: #333;
        --muted-text: #7f8c8d;
        --danger-color: #e74c3c;
        --success-color: #27ae60;
        --header-height: 50px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Top Bar */
      header {
        height: var(--header-height);
        background-color: var(--header-bg);
        color: var(--header-text);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        font-size: 16px;
        font-weight: 600;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      header .actions button {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 5px 12px;
        margin-left: 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
      }
      header .actions button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Layout */
      .workspace {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      .col {
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        background: var(--col-bg);
        overflow: hidden;
      }

      .col-left {
        width: 250px;
        flex-shrink: 0;
        background: #f8f9fa;
      }
      .col-mid {
        flex: 1;
        min-width: 400px;
      }
      .col-right {
        width: 40%;
        min-width: 350px;
        border-right: none;
        background: #fafafa;
      }

      .col-header {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-color);
        background: #fff;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 45px;
        flex-shrink: 0;
      }

      .scroll-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      /* Left Col: Projects */
      .project-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background 0.2s;
      }
      .project-item:hover {
        background: #eef2f7;
      }
      .project-item.active {
        background: #dceefb;
        border-left: 4px solid var(--primary-color);
      }
      .project-item .title {
        font-weight: 500;
        display: block;
        margin-bottom: 2px;
      }
      .project-item .meta {
        font-size: 11px;
        color: var(--muted-text);
      }

      .btn-new {
        width: 100%;
        padding: 8px;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-new:hover {
        background: #2980b9;
      }

      /* Middle Col: Form */
      .form-section {
        margin-bottom: 30px;
        border: 1px solid #eee;
        border-radius: 4px;
        background: #fff;
      }
      .form-section-header {
        background: #f1f2f6;
        padding: 10px 15px;
        font-weight: bold;
        border-bottom: 1px solid #ddd;
        color: #2c3e50;
      }
      .form-section-body {
        padding: 15px;
      }

      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 13px;
        color: #555;
      }
      .form-group input[type="text"],
      .form-group input[type="date"],
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
      }
      .form-group textarea {
        min-height: 80px;
        resize: vertical;
      }

      .checkbox-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: normal;
        cursor: pointer;
      }
      .checkbox-group input {
        margin-right: 8px;
      }

      .scenario-card {
        background: #f9f9f9;
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
      }
      .scenario-card h5 {
        margin: 0 0 10px 0;
        font-size: 13px;
        color: #7f8c8d;
      }

      /* Right Col: Preview */
      #preview-content {
        white-space: pre-wrap;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 13px;
        line-height: 1.5;
        color: #2c3e50;
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 200px;
      }

      .preview-alert {
        margin-top: 15px;
        font-size: 12px;
        color: var(--danger-color);
        background: #fdedec;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #fadbd8;
        font-weight: bold;
      }

      .copy-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .btn-copy {
        flex: 1;
        padding: 6px;
        font-size: 12px;
        cursor: pointer;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .btn-copy:hover {
        background: #f0f0f0;
      }

      /* Utility */
      .hidden {
        display: none;
      }
      .required-mark {
        color: red;
        margin-left: 2px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">SOPForm Studio (SFS)</div>
      <div class="actions">
        <button onclick="app.importJSON()">Import JSON</button>
        <button onclick="app.exportJSON()">Export JSON</button>
        <button onclick="app.exportMarkdown()">Export MD</button>
      </div>
      <input type="file" id="fileInput" class="hidden" accept=".json" />
    </header>

    <div class="workspace">
      <!-- LEFT: Project List -->
      <div class="col col-left">
        <button class="btn-new" onclick="app.createNewProject()">
          + New Project
        </button>
        <div class="scroll-container" id="project-list">
          <!-- Projects go here -->
        </div>
      </div>

      <!-- MIDDLE: Editor -->
      <div class="col col-mid">
        <div class="col-header">
          <span>系统决策表 v1.0（删负责人）</span>
          <button
            onclick="app.deleteCurrentProject()"
            style="
              font-size: 11px;
              color: #e74c3c;
              border: none;
              background: none;
              cursor: pointer;
            "
          >
            Delete Project
          </button>
        </div>
        <div class="scroll-container" id="editor-container">
          <div id="form-root"></div>
        </div>
      </div>

      <!-- RIGHT: Preview -->
      <div class="col col-right">
        <div class="col-header">
          <span>可复制输入块（实时生成）</span>
          <span
            id="copy-feedback"
            style="font-size: 11px; color: green; display: none"
            >Copied!</span
          >
        </div>
        <div class="scroll-container">
          <div class="copy-actions">
            <button class="btn-copy" onclick="app.copyToClipboard('all')">
              Copy All
            </button>
            <button class="btn-copy" onclick="app.copyToClipboard('A')">
              Copy A Only
            </button>
            <button class="btn-copy" onclick="app.copyToClipboard('B')">
              Copy B Only
            </button>
          </div>
          <div id="preview-content"></div>
          <div class="preview-alert">
            Rule: Missing fields must be asked. Do not assume.
          </div>
        </div>
      </div>
    </div>

    <script>
      /**
       * SOPForm Studio v1.0.0
       * Single-file implementation
       */

      const SCHEMA_VERSION = "1.0.0";
      const STORAGE_KEY = "sfs_v1_store";

      const DEFAULT_C_TEXT = `- 默认状态机：submitted → approved/rejected
- 默认真源：反馈不改真源；改真源需管理员确认/更新请求
- 默认幂等：写入接口必须可去重（requestId或唯一键）
- 默认权限：最小权限；未审核仅提交者+管理员可见
- 默认可观测：关键写入必须审计日志（who/when/entity/action/result）`;

      // --- Data Structure ---
      class Store {
        constructor() {
          this.projects = [];
          this.load();
          if (this.projects.length === 0) {
            this.addProject("My First Project");
          }
          this.activeId = this.projects[0].id;
        }

        load() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
              const parsed = JSON.parse(raw);
              // Simple migration/validation could go here
              this.projects = parsed;
            }
          } catch (e) {
            console.error("Failed to load data", e);
            this.projects = [];
          }
        }

        save() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(this.projects));
        }

        addProject(name) {
          const newProject = {
            id: Date.now().toString(),
            meta: {
              name: name,
              version: "v1.0.0",
              date: new Date().toISOString().split("T")[0],
            },
            data: {
              A: {
                goals: "",
                nonGoals: "",
                roles: "",
                visibilityPending: "",
                visibilityApproved: "",
                roleActions: "",
                workflow: "",
                scenarios: [
                  { name: "", trigger: "", env: "", response: "", metric: "" },
                  { name: "", trigger: "", env: "", response: "", metric: "" },
                  { name: "", trigger: "", env: "", response: "", metric: "" },
                  { name: "", trigger: "", env: "", response: "", metric: "" },
                ],
                constraints: "",
                acceptanceCriteria: "",
                evidence: {
                  demo: false,
                  steps: false,
                  pathTest: false,
                  auditLog: false,
                  record: false,
                },
              },
              B: {
                modules: "",
                apiBoundaries: "",
                entities: "",
                sourceOfTruth: "",
                derivedFields: "",
                auditFields: "",
                stateMachineAdd: "no", // "no" or "yes"
                stateMachineCustom: "",
                transitions: "",
                duplicateDef: "",
                dedupStrategy: "",
                retryStrategy: "",
                logFields: "",
                metrics: "",
                errorLoc: "",
                authn: "",
                authz: "",
                validation: "",
                privacy: "",
              },
              C: {
                preferences: DEFAULT_C_TEXT,
              },
            },
          };
          this.projects.unshift(newProject);
          this.activeId = newProject.id;
          this.save();
          return newProject;
        }

        deleteProject(id) {
          this.projects = this.projects.filter((p) => p.id !== id);
          if (this.projects.length === 0) {
            this.addProject("New Project");
          }
          if (this.activeId === id) {
            this.activeId = this.projects[0].id;
          }
          this.save();
        }

        getActiveProject() {
          return (
            this.projects.find((p) => p.id === this.activeId) ||
            this.projects[0]
          );
        }

        updateActiveProject(path, value) {
          const project = this.getActiveProject();
          // Simple path setter
          const parts = path.split(".");
          let current = project;
          for (let i = 0; i < parts.length - 1; i++) {
            current = current[parts[i]];
          }
          current[parts[parts.length - 1]] = value;
          this.save();
          app.render(); // Re-render logic
        }
      }

      // --- App Logic ---
      const store = new Store();

      const app = {
        init() {
          this.render();
          // File input listener
          document
            .getElementById("fileInput")
            .addEventListener("change", (e) => {
              const file = e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (ev) => {
                try {
                  const json = JSON.parse(ev.target.result);
                  if (json.schemaVersion !== SCHEMA_VERSION) {
                    alert("Warning: Schema version mismatch or invalid file.");
                  }
                  // Merge logic: import as new projects
                  if (Array.isArray(json.projects)) {
                    json.projects.forEach((p) => {
                      p.id =
                        Date.now().toString() +
                        Math.random().toString().slice(2, 5); // ensure unique ID
                      store.projects.unshift(p);
                    });
                    store.activeId = store.projects[0].id; // Switch to newest imported
                    store.save();
                    this.render();
                    alert("Import successful!");
                  } else {
                    alert("Invalid format: missing 'projects' array.");
                  }
                } catch (err) {
                  alert("Failed to parse JSON: " + err.message);
                }
              };
              reader.readAsText(file);
              e.target.value = ""; // reset
            });
        },

        render() {
          this.renderProjectList();
          this.renderForm();
          this.renderPreview();
        },

        createNewProject() {
          const name = prompt("Enter Project Name:", "New Project");
          if (name) {
            store.addProject(name);
            this.render();
          }
        },

        deleteCurrentProject() {
          if (confirm("Are you sure you want to delete this project?")) {
            store.deleteProject(store.activeId);
            this.render();
          }
        },

        switchProject(id) {
          store.activeId = id;
          this.render();
        },

        renderProjectList() {
          const list = document.getElementById("project-list");
          list.innerHTML = store.projects
            .map(
              (p) => `
                    <div class="project-item ${p.id === store.activeId ? "active" : ""}" onclick="app.switchProject('${p.id}')">
                        <span class="title">${this.escape(p.meta.name)}</span>
                        <span class="meta">${p.meta.version} • ${p.meta.date}</span>
                    </div>
                `,
            )
            .join("");
        },

        renderForm() {
          const p = store.getActiveProject();
          const container = document.getElementById("form-root");

          // Helper to generate inputs
          const textInput = (label, path, placeholder = "") => `
                    <div class="form-group">
                        <label>${label}</label>
                        <input type="text" value="${this.escape(this.get(p, path))}" 
                            oninput="store.updateActiveProject('${path}', this.value)" placeholder="${placeholder}">
                    </div>`;

          const textArea = (label, path, placeholder = "") => `
                    <div class="form-group">
                        <label>${label}</label>
                        <textarea oninput="store.updateActiveProject('${path}', this.value)" placeholder="${placeholder}">${this.escape(this.get(p, path))}</textarea>
                    </div>`;

          const dateInput = (label, path) => `
                    <div class="form-group">
                        <label>${label}</label>
                        <input type="date" value="${this.escape(this.get(p, path))}" 
                            oninput="store.updateActiveProject('${path}', this.value)">
                    </div>`;

          // --- META ---
          let html = `
                <div class="form-section">
                    <div class="form-section-header">Project Meta</div>
                    <div class="form-section-body">
                        ${textInput("名称 (Name)", "meta.name")}
                        ${textInput("版本 (Version)", "meta.version")}
                        ${dateInput("日期 (Date)", "meta.date")}
                    </div>
                </div>`;

          // --- SECTION A ---
          html += `
                <div class="form-section">
                    <div class="form-section-header">A) 输入护栏</div>
                    <div class="form-section-body">
                        <h3>A1 目标 & 非目标</h3>
                        ${textInput("目标（一句话）", "data.A.goals")}
                        ${textArea("非目标（至少3条）", "data.A.nonGoals", "item1, item2, item3")}

                        <h3>A2 角色/权限/可见性</h3>
                        ${textArea("角色列表", "data.A.roles")}
                        <div class="form-group">
                            <label>未审核内容谁能看？</label>
                            <select onchange="store.updateActiveProject('data.A.visibilityPending', this.value)">
                                <option value="" ${!p.data.A.visibilityPending ? "selected" : ""}>-- Select --</option>
                                <option value="仅提交者+管理员" ${p.data.A.visibilityPending === "仅提交者+管理员" ? "selected" : ""}>仅提交者+管理员</option>
                                <option value="仅管理员" ${p.data.A.visibilityPending === "仅管理员" ? "selected" : ""}>仅管理员</option>
                                <option value="所有人(需理由)" ${p.data.A.visibilityPending === "所有人(需理由)" ? "selected" : ""}>所有人(需理由)</option>
                            </select>
                        </div>
                        ${textInput("审核后谁能看？", "data.A.visibilityApproved")}
                        ${textArea("各角色能做什么（简写）", "data.A.roleActions")}

                        <h3>A3 最小闭环流程</h3>
                        ${textArea("5~10步，端到端", "data.A.workflow", "Step 1...")}

                        <h3>A4 质量属性（至少4个情景）</h3>
                        ${p.data.A.scenarios
                          .map(
                            (s, i) => `
                            <div class="scenario-card">
                                <h5>Scenario #${i + 1}</h5>
                                ${textInput("名称", `data.A.scenarios.${i}.name`)}
                                ${textInput("触发", `data.A.scenarios.${i}.trigger`)}
                                ${textInput("环境", `data.A.scenarios.${i}.env`)}
                                ${textInput("响应", `data.A.scenarios.${i}.response`)}
                                ${textInput("指标", `data.A.scenarios.${i}.metric`)}
                            </div>
                        `,
                          )
                          .join("")}

                        <h3>A5 约束</h3>
                        ${textInput("技术栈", "data.A.constraints")}

                        <h3>A6 验收证据</h3>
                        ${textArea("验收用例（3~8条）", "data.A.acceptanceCriteria")}
                        <div class="checkbox-group">
                            <label><b>证据勾选:</b></label>
                            ${this.checkbox("可运行Demo", "data.A.evidence.demo", p.data.A.evidence.demo)}
                            ${this.checkbox("可复现步骤", "data.A.evidence.steps", p.data.A.evidence.steps)}
                            ${this.checkbox("关键路径测试", "data.A.evidence.pathTest", p.data.A.evidence.pathTest)}
                            ${this.checkbox("关键写入审计日志", "data.A.evidence.auditLog", p.data.A.evidence.auditLog)}
                            ${this.checkbox("验收记录", "data.A.evidence.record", p.data.A.evidence.record)}
                        </div>
                    </div>
                </div>`;

          // --- SECTION B ---
          html += `
                <div class="form-section">
                    <div class="form-section-header">B) 设计决策</div>
                    <div class="form-section-body">
                        <h3>B1 边界/模块/API</h3>
                        ${textArea("模块（3~7个）+职责", "data.B.modules")}
                        ${textInput("API边界", "data.B.apiBoundaries")}

                        <h3>B2 数据模型</h3>
                        ${textInput("核心实体", "data.B.entities")}
                        ${textInput("真源是谁/在哪里", "data.B.sourceOfTruth")}
                        ${textInput("派生/缓存字段", "data.B.derivedFields")}
                        ${textInput("审计必须字段", "data.B.auditFields", "who/when/entity/action/result...")}

                        <h3>B3 状态机</h3>
                        <div class="form-group">
                            <label>你要加状态吗？</label>
                            <select onchange="store.updateActiveProject('data.B.stateMachineAdd', this.value)">
                                <option value="no" ${p.data.B.stateMachineAdd === "no" ? "selected" : ""}>不加 (默认3态)</option>
                                <option value="yes" ${p.data.B.stateMachineAdd === "yes" ? "selected" : ""}>要加</option>
                            </select>
                        </div>
                        ${p.data.B.stateMachineAdd === "yes" ? textInput("要加的状态", "data.B.stateMachineCustom") : ""}
                        ${textInput("允许的流转", "data.B.transitions")}

                        <h3>B4 幂等/去重/并发</h3>
                        ${textInput("“重复提交”怎么定义", "data.B.duplicateDef")}
                        <div class="form-group">
                            <label>去重策略</label>
                            <select onchange="store.updateActiveProject('data.B.dedupStrategy', this.value)">
                                <option value="" ${!p.data.B.dedupStrategy ? "selected" : ""}>-- Select --</option>
                                <option value="requestId幂等" ${p.data.B.dedupStrategy === "requestId幂等" ? "selected" : ""}>requestId幂等</option>
                                <option value="业务唯一键" ${p.data.B.dedupStrategy === "业务唯一键" ? "selected" : ""}>业务唯一键</option>
                                <option value="允许重复后台合并" ${p.data.B.dedupStrategy === "允许重复后台合并" ? "selected" : ""}>允许重复后台合并</option>
                            </select>
                        </div>
                        ${textInput("重试策略", "data.B.retryStrategy")}

                        <h3>B5 可观测性</h3>
                        ${textInput("关键写入日志字段", "data.B.logFields")}
                        ${textInput("关键指标", "data.B.metrics")}
                        ${textInput("出错最小定位要求", "data.B.errorLoc")}

                        <h3>B6 安全与隐私</h3>
                        ${textInput("鉴权方式", "data.B.authn")}
                        ${textInput("授权规则", "data.B.authz")}
                        ${textInput("输入校验", "data.B.validation")}
                        ${textInput("隐私策略", "data.B.privacy")}
                    </div>
                </div>`;

          // --- SECTION C ---
          html += `
                <div class="form-section">
                    <div class="form-section-header">C) 默认偏好</div>
                    <div class="form-section-body">
                        ${textArea("Default Preferences", "data.C.preferences")}
                    </div>
                </div>`;

          container.innerHTML = html;
        },

        renderPreview() {
          const p = store.getActiveProject();
          const d = p.data;
          const esc = (v) => (v && v.trim().length > 0 ? v : "(Not filled)");
          const checked = (v) => (v ? "[x]" : "[ ]");

          let text = `# Project: ${esc(p.meta.name)}
Version: ${esc(p.meta.version)}
Date: ${esc(p.meta.date)}

===============================================================================
A) 输入护栏（外部世界：取舍/风险/验收）✅必须你填，AI不得脑补
===============================================================================
A1 目标 & 非目标
- 目标: ${esc(d.A.goals)}
- 非目标: 
${this.indent(d.A.nonGoals)}

A2 角色/权限/可见性
- 角色列表: ${esc(d.A.roles)}
- 未审核内容谁能看？: ${esc(d.A.visibilityPending)}
- 审核后谁能看？: ${esc(d.A.visibilityApproved)}
- 各角色能做什么: ${esc(d.A.roleActions)}

A3 最小闭环流程
${this.indent(d.A.workflow)}

A4 质量属性
${d.A.scenarios
  .map(
    (s, i) => `Scenario #${i + 1}:
- 名称: ${esc(s.name)}
- 触发: ${esc(s.trigger)}
- 环境: ${esc(s.env)}
- 响应: ${esc(s.response)}
- 指标: ${esc(s.metric)}`,
  )
  .join("\n\n")}

A5 约束
- 技术栈: ${esc(d.A.constraints)}

A6 验收证据
- 验收用例:
${this.indent(d.A.acceptanceCriteria)}

- 证据勾选:
  ${checked(d.A.evidence.demo)} 可运行Demo
  ${checked(d.A.evidence.steps)} 可复现步骤
  ${checked(d.A.evidence.pathTest)} 关键路径测试
  ${checked(d.A.evidence.auditLog)} 关键写入审计日志
  ${checked(d.A.evidence.record)} 验收记录

===============================================================================
B) 设计决策（工程内部：系统怎么组织）✅AI可给方案，但你拍板关键点
===============================================================================
B1 边界/模块/API
- 模块+职责:
${this.indent(d.B.modules)}
- API边界: ${esc(d.B.apiBoundaries)}

B2 数据模型
- 核心实体: ${esc(d.B.entities)}
- 真源: ${esc(d.B.sourceOfTruth)}
- 派生/缓存: ${esc(d.B.derivedFields)}
- 审计字段: ${esc(d.B.auditFields)}

B3 状态机
- 加状态?: ${d.B.stateMachineAdd === "yes" ? "是: " + esc(d.B.stateMachineCustom) : "否 (默认3态)"}
- 允许的流转: ${esc(d.B.transitions)}

B4 幂等/去重/并发
- 重复提交定义: ${esc(d.B.duplicateDef)}
- 去重策略: ${esc(d.B.dedupStrategy)}
- 重试策略: ${esc(d.B.retryStrategy)}

B5 可观测性
- 关键写入日志: ${esc(d.B.logFields)}
- 关键指标: ${esc(d.B.metrics)}
- 出错定位: ${esc(d.B.errorLoc)}

B6 安全与隐私
- 鉴权: ${esc(d.B.authn)}
- 授权: ${esc(d.B.authz)}
- 校验: ${esc(d.B.validation)}
- 隐私: ${esc(d.B.privacy)}

===============================================================================
C) 默认偏好（可先不填；长期维护，AI用来“没写就按默认”）
===============================================================================
${esc(d.C.preferences)}

Rule: Missing fields must be asked. Do not assume.`;

          document.getElementById("preview-content").textContent = text;
        },

        // --- Utilities ---
        escape(str) {
          return (str || "").replace(/"/g, "&quot;");
        },

        get(obj, path) {
          return path.split(".").reduce((acc, part) => acc && acc[part], obj);
        },

        indent(str) {
          if (!str) return "(Not filled)";
          return str
            .split("\n")
            .map((line) => "  " + line)
            .join("\n");
        },

        checkbox(label, path, checked) {
          return `<div class="checkbox-item"><label><input type="checkbox" ${checked ? "checked" : ""} onchange="store.updateActiveProject('${path}', this.checked)"> ${label}</label></div>`;
        },

        // --- Actions ---
        copyToClipboard(mode) {
          const fullText =
            document.getElementById("preview-content").textContent;
          let textToCopy = fullText;

          if (mode === "A") {
            const start = fullText.indexOf("A) 输入护栏");
            const end = fullText.indexOf("B) 设计决策");
            const header = fullText.substring(0, fullText.indexOf("====="));
            textToCopy = header + fullText.substring(start, end);
          } else if (mode === "B") {
            const start = fullText.indexOf("B) 设计决策");
            const end = fullText.indexOf("C) 默认偏好");
            const header = fullText.substring(0, fullText.indexOf("====="));
            textToCopy = header + fullText.substring(start, end);
          }

          navigator.clipboard.writeText(textToCopy).then(() => {
            const fb = document.getElementById("copy-feedback");
            fb.style.display = "inline";
            setTimeout(() => (fb.style.display = "none"), 2000);
          });
        },

        exportJSON() {
          const data = {
            schemaVersion: SCHEMA_VERSION,
            exportedAt: new Date().toISOString(),
            projects: store.projects,
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `sfs_backup_${new Date().toISOString().slice(0, 10)}.json`;
          a.click();
        },

        exportMarkdown() {
          const text = document.getElementById("preview-content").textContent;
          const blob = new Blob([text], { type: "text/markdown" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const pName = store.getActiveProject().meta.name.replace(/\s+/g, "_");
          a.download = `${pName}_spec.md`;
          a.click();
        },

        importJSON() {
          document.getElementById("fileInput").click();
        },
      };

      // Boot
      app.init();
    </script>

    <!-- 
      Self-Test Checklist:
      1. Open file -> See default project "New Project"
      2. Type in "A1 目标" -> Check Preview updates instantly
      3. Switch Project -> Data persists
      4. Export JSON -> Check schemaVersion "1.0.0"
      5. Reload page -> Data persists (localStorage)
    -->
  </body>
</html>
